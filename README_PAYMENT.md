# üöÄ –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç - –ü–ª–∞—Ç—ñ–∂–Ω–∞ —Å–∏—Å—Ç–µ–º–∞

## ‚úÖ –©–æ –∑—Ä–æ–±–ª–µ–Ω–æ

### üéØ –û—Å–Ω–æ–≤–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è
- ‚ùå **–ë—É–ª–∞ –∑–∞–≥–ª—É—à–∫–∞** ‚Üí ‚úÖ **–ü–æ–≤–Ω–æ—Ü—ñ–Ω–Ω–∞ Stripe —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è**  
- ‚ùå **–ë–∞–∑–æ–≤–∏–π UI** ‚Üí ‚úÖ **–ö—Ä–∞—Å–∏–≤—ñ HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∏**
- ‚ùå **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è** ‚Üí ‚úÖ **–î–µ—Ç–∞–ª—å–Ω–∏–π UX**
- ‚ùå **–ë–µ–∑ –æ–±—Ä–æ–±–∫–∏ –ø–æ–º–∏–ª–æ–∫** ‚Üí ‚úÖ **–ù–∞–¥—ñ–π–Ω–∞ —Å–∏—Å—Ç–µ–º–∞**

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª—ñ–≤

```
Bot/
‚îú‚îÄ‚îÄ templates/                    # üÜï HTML —à–∞–±–ª–æ–Ω–∏
‚îÇ   ‚îú‚îÄ‚îÄ payment_success.html     # –°—Ç–æ—Ä—ñ–Ω–∫–∞ —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–ª–∞—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ payment_cancel.html      # –°—Ç–æ—Ä—ñ–Ω–∫–∞ —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è  
‚îÇ   ‚îî‚îÄ‚îÄ payment_info.html        # –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ payment_utils.py         # ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ - Stripe API
‚îÇ   ‚îú‚îÄ‚îÄ error_handler.py         # üÜï –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
‚îÇ   ‚îî‚îÄ‚îÄ template_utils.py        # üÜï –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ HTML
‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îú‚îÄ‚îÄ payment.py               # ‚úÖ –ü–æ–≤–Ω—ñ—Å—Ç—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–æ
‚îÇ   ‚îî‚îÄ‚îÄ webhook.py               # ‚úÖ –û–Ω–æ–≤–ª–µ–Ω–æ –∑ HTML
‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îî‚îÄ‚îÄ inline.py                # ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω—ñ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îî‚îÄ‚îÄ PAYMENT_SETUP.md            # üÜï –î–µ—Ç–∞–ª—å–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
```

## ‚ö° –®–≤–∏–¥–∫–∏–π –∑–∞–ø—É—Å–∫

### 1. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è Stripe
```bash
# –î–æ–¥–∞–π—Ç–µ —É .env —Ñ–∞–π–ª:
STRIPE_SECRET_KEY=sk_test_...
STRIPE_WEBHOOK_SECRET=whsec_...  
WEBHOOK_URL=https://yourdomain.com
```

### 2. Stripe Dashboard
1. –°—Ç–≤–æ—Ä—ñ—Ç—å webhook: `https://yourdomain.com/webhook/stripe`
2. –í–∏–±–µ—Ä—ñ—Ç—å –ø–æ–¥—ñ—ó: `checkout.session.completed`, `checkout.session.expired`
3. –°–∫–æ–ø—ñ—é–π—Ç–µ webhook secret

### 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞
```bash
# –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —à–∞–±–ª–æ–Ω–∏
python3 -c "from utils.template_utils import validate_template_files; print(validate_template_files())"

# –†–µ–∑—É–ª—å—Ç–∞—Ç: {'payment_success.html': True, 'payment_cancel.html': True, 'payment_info.html': True}
```

## üîÑ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –ø–æ—Ç—ñ–∫

```mermaid
graph LR
    A[–§–∞–π–ª] --> B[–ú–æ–¥–µ–ª—å] --> C[–¶—ñ–Ω–∞] --> D[Stripe] --> E[–£—Å–ø—ñ—Ö] --> F[–ü–µ—Ä–µ–∫–ª–∞–¥]
    D --> G[–°–∫–∞—Å—É–≤–∞–Ω–Ω—è] --> H[–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –±–æ—Ç–∞]
```

1. **–§–∞–π–ª** ‚Üí –ê–Ω–∞–ª—ñ–∑ —Å–∏–º–≤–æ–ª—ñ–≤
2. **–ú–æ–¥–µ–ª—å** ‚Üí Basic (0.65‚Ç¨) –∞–±–æ Epic (0.95‚Ç¨)  
3. **–û–ø–ª–∞—Ç–∞** ‚Üí Stripe –≤—ñ–∫–Ω–æ –≤ Telegram
4. **–£—Å–ø—ñ—Ö** ‚Üí –ö—Ä–∞—Å–∏–≤–∞ HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∞ ‚Üí –ê–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è
5. **–ü–µ—Ä–µ–∫–ª–∞–¥** ‚Üí –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–æ—á–∞—Ç–æ–∫

## üé® HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∏

### üéâ –£—Å–ø—ñ—à–Ω–∞ –æ–ø–ª–∞—Ç–∞ (`/success`)
- ‚úÖ –ê–Ω—ñ–º–æ–≤–∞–Ω–∏–π —ñ–∫–æ–Ω–∫–∞ —É—Å–ø—ñ—Ö—É
- üìä –î–µ—Ç–∞–ª—ñ –ø–ª–∞—Ç–µ–∂—É (—Å—É–º–∞, –º–æ–¥–µ–ª—å, —Å–∏–º–≤–æ–ª–∏)
- üöÄ Progress bar –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
- ‚è∞ –ê–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
- üéØ Responsive –¥–∏–∑–∞–π–Ω

### ‚ùå –°–∫–∞—Å—É–≤–∞–Ω–Ω—è (`/cancel`)  
- üîÑ Reasons –¥–ª—è —Å–∫–∞—Å—É–≤–∞–Ω–Ω—è
- üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–µ–∑–ø–µ–∫–∏ (0‚Ç¨ —Å–ø–∏—Å–∞–Ω–æ)
- üí° –ü—ñ–¥–∫–∞–∑–∫–∏ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- ‚è∞ –ê–≤—Ç–æ–∑–∞–∫—Ä–∏—Ç—Ç—è —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥–∏

### üìã –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è (`/info`)
- üí∞ –î–µ—Ç–∞–ª—å–Ω—ñ —Ü—ñ–Ω–∏ –æ–±–æ—Ö –º–æ–¥–µ–ª–µ–π
- üîí –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –±–µ–∑–ø–µ–∫—É
- üéØ –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –∫–æ–∂–Ω–æ—ó –º–æ–¥–µ–ª—ñ
- üì± CTA –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –≤ –±–æ—Ç

## üîß –¢–µ—Ö–Ω—ñ—á–Ω—ñ –¥–µ—Ç–∞–ª—ñ

### Stripe —Å–µ—Å—ñ—ó
```python
# –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è Telegram
payment_method_types=['card', 'google_pay', 'apple_pay']
expires_at = 30 —Ö–≤–∏–ª–∏–Ω
ui_mode = 'hosted'  # –î–ª—è –∫—Ä–∞—â–æ—ó —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó
```

### Webhook –æ–±—Ä–æ–±–∫–∞
```python
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º
checkout.session.completed ‚Üí "–û–ø–ª–∞—Ç–∞ —É—Å–ø—ñ—à–Ω–∞! –ü–æ—á–∏–Ω–∞—î–º–æ –ø–µ—Ä–µ–∫–ª–∞–¥..."
checkout.session.expired ‚Üí "–ß–∞—Å —Å–µ—Å—ñ—ó –º–∏–Ω—É–≤. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."
```

### Error Handling
```python
@payment_error_handler
def function():
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
    # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
    # Graceful degradation
```

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### Stripe —Ç–µ—Å—Ç–æ–≤—ñ –∫–∞—Ä—Ç–∫–∏
```
4242 4242 4242 4242  # Visa —É—Å–ø—ñ—à–Ω–∞
4000 0000 0000 0002  # Decline
4000 0000 0000 9995  # –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –∫–æ—à—Ç—ñ–≤
```

### –õ–æ–∫–∞–ª—å–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è
```bash
# 1. –ó–∞–ø—É—Å—Ç—ñ—Ç—å –±–æ—Ç–∞
python3 bot.py

# 2. –ó–∞–ø—É—Å—Ç—ñ—Ç—å ngrok (–¥–ª—è HTTPS)  
ngrok http 8000

# 3. –û–Ω–æ–≤—ñ—Ç—å WEBHOOK_URL —É .env
WEBHOOK_URL=https://abc123.ngrok.io

# 4. –¢–µ—Å—Ç—É–π—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫–∏:
# https://abc123.ngrok.io/success?user_id=123&amount=2.50&model=epic&char_count=5000
# https://abc123.ngrok.io/cancel?user_id=123&reason=user_cancelled
# https://abc123.ngrok.io/info
```

## üìä –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
```
logs/
‚îú‚îÄ‚îÄ bot.log      # –ó–∞–≥–∞–ª—å–Ω—ñ –ª–æ–≥–∏
‚îî‚îÄ‚îÄ payment.log  # –ü–ª–∞—Ç—ñ–∂–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
```

### –ö–ª—é—á–æ–≤—ñ –º–µ—Ç—Ä–∏–∫–∏
- üí≥ –£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å –ø–ª–∞—Ç–µ–∂—ñ–≤
- ‚è±Ô∏è –ß–∞—Å –æ–±—Ä–æ–±–∫–∏ Stripe —Å–µ—Å—ñ–π  
- üîÑ –ö–æ–Ω–≤–µ—Ä—Å—ñ—è –ø–æ –º–æ–¥–µ–ª—è—Ö
- üìà –°–µ—Ä–µ–¥–Ω—è —Å—É–º–∞ –ø–ª–∞—Ç–µ–∂—É

## üö® Production Checklist

- [ ] –†–µ–∞–ª—å–Ω–∏–π Stripe API –∫–ª—é—á (–Ω–µ test)
- [ ] HTTPS —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç 
- [ ] Webhook endpoint –¥–æ—Å—Ç—É–ø–Ω–∏–π
- [ ] –õ–æ–≥—É–≤–∞–Ω–Ω—è –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ
- [ ] Error handling –ø–µ—Ä–µ–≤—ñ—Ä–µ–Ω–æ
- [ ] HTML —à–∞–±–ª–æ–Ω–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å—Å—è
- [ ] Success/cancel URLs –ø—Ä–∞—Ü—é—é—Ç—å
- [ ] –¢–µ—Å—Ç–æ–≤—ñ –ø–ª–∞—Ç–µ–∂—ñ –ø—Ä–æ—Ö–æ–¥—è—Ç—å

## üìû –ü—ñ–¥—Ç—Ä–∏–º–∫–∞  

**–ü—Ä–æ–±–ª–µ–º–∏ –∑ –ø–ª–∞—Ç–µ–∂–∞–º–∏?**
1. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ `logs/payment.log`
2. Validate Stripe webhook –≤ Dashboard  
3. –¢–µ—Å—Ç—É–π—Ç–µ HTML —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –æ–∫—Ä–µ–º–æ
4. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ HTTPS —Ç–∞ –¥–æ–º–µ–Ω

**–ö–æ—Ä–∏—Å–Ω—ñ –ø–æ—Å–∏–ª–∞–Ω–Ω—è:**
- [Stripe Dashboard](https://dashboard.stripe.com/)
- [Stripe Webhooks](https://dashboard.stripe.com/webhooks)  
- [Stripe Test Cards](https://stripe.com/docs/testing#cards)

---
**üéâ –ì–æ—Ç–æ–≤–æ! –í–∞—à–∞ –ø–ª–∞—Ç—ñ–∂–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î —è–∫ —à–≤–µ–π—Ü–∞—Ä—Å—å–∫–∏–π –≥–æ–¥–∏–Ω–Ω–∏–∫!**