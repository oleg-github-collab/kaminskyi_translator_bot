# üîß –ö–†–ò–¢–ò–ß–ù–Ü –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø USER FLOW

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê –Ø–ö–ê –ë–£–õ–ê
–ë–æ—Ç –∑–∞–≤–∏—Å–∞–≤ –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –º–æ–¥–µ–ª—ñ —á–µ—Ä–µ–∑ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é handler'—ñ–≤.

## ‚úÖ –©–û –í–ò–ü–†–ê–í–õ–ï–ù–û

### üéØ 1. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ Handler'–∏ –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏

**‚ùå –ë—É–ª–æ (handlers/start.py:157):**
```python
# –ë–ï–ó –§–Ü–õ–¨–¢–†–Ü–í - –ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞–ª–æ –≤—Å—ñ callback'–∏!
dp.register_callback_query_handler(choose_model)
```

**‚úÖ –°—Ç–∞–ª–æ:**
```python
# –ó –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º —Ñ—ñ–ª—å—Ç—Ä–æ–º —ñ —Å—Ç–∞–Ω–æ–º
dp.register_callback_query_handler(
    choose_model, 
    lambda c: c.data and c.data.startswith("model_"),
    state=TranslationStates.choosing_model
)
```

### üåê 2. –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ Language Handler'–∏

**‚ùå –ë—É–ª–æ (handlers/language.py:121-122):**
```python
# –ë–ï–ó –û–ë–ú–ï–ñ–ï–ù–¨ - –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É–≤–∞–ª–æ!
dp.register_callback_query_handler(choose_source_language)
dp.register_callback_query_handler(choose_target_language)
```

**‚úÖ –°—Ç–∞–ª–æ:**
```python
# –ó –ø—Ä–∞–≤–∏–ª—å–Ω–∏–º–∏ —Å—Ç–∞–Ω–∞–º–∏ —ñ —Ñ—ñ–ª—å—Ç—Ä–∞–º–∏
dp.register_callback_query_handler(
    choose_source_language,
    lambda c: c.data and c.data.startswith("lang_"),
    state=TranslationStates.waiting_for_source_language
)
dp.register_callback_query_handler(
    choose_target_language,
    lambda c: c.data and c.data.startswith("lang_"),
    state=TranslationStates.waiting_for_target_language
)
```

## üöÄ –ù–û–í–Ü –°–£–ü–ï–†-–§–£–ù–ö–¶–Ü–á

### üîç 1. –°–∏—Å—Ç–µ–º–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
```
utils/debug_logger.py - –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –¥—ñ–π
logs/debug_flow.log - –æ–∫—Ä–µ–º–∏–π —Ñ–∞–π–ª –¥–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
```

### üéØ 2. Flow Manager - —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –∫–µ—Ä—É–≤–∞–Ω–Ω—è
```
utils/flow_manager.py:
- safe_state_transition() - –±–µ–∑–ø–µ—á–Ω—ñ –ø–µ—Ä–µ—Ö–æ–¥–∏ –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏
- get_user_progress() - –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
- validate_user_data() - –≤–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö
- handle_error_recovery() - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
```

### üõ°Ô∏è 3. –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π Handler - –ø–æ–≤–Ω–∏–π fallback
```
handlers/universal.py - –ø–µ—Ä–µ—Ö–æ–ø–ª—é—î –≤—Å—ñ –ø—Ä–æ–±–ª–µ–º–Ω—ñ callback'–∏:
- handle_model_selection() - –æ–±—Ä–æ–±–∫–∞ –º–æ–¥–µ–ª–µ–π
- handle_language_selection() - –æ–±—Ä–æ–±–∫–∞ –º–æ–≤
- handle_payment_callbacks() - –ø–ª–∞—Ç—ñ–∂–Ω—ñ callback'–∏  
- handle_unknown_callback() - –Ω–µ–≤—ñ–¥–æ–º—ñ –∫–æ–º–∞–Ω–¥–∏
```

### üìä 4. Debug Middleware - –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
```python
# –î–æ–¥–∞–Ω–æ –≤ bot.py
from utils.debug_logger import DebugMiddleware
debug_middleware = DebugMiddleware()
dp.middleware.setup(debug_middleware)
```

## üéØ –ü–û–í–ù–ò–ô USER FLOW - –ö–†–û–ö –ó–ê –ö–†–û–ö–û–ú

```
1. /start ‚Üí TranslationStates.choosing_model
   ‚Üì model_basic/model_epic
   
2. choose_model() ‚Üí TranslationStates.waiting_for_source_language  
   ‚Üì lang_UK/lang_EN/etc
   
3. choose_source_language() ‚Üí TranslationStates.waiting_for_target_language
   ‚Üì lang_UK/lang_EN/etc (–ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —Ä—ñ–∑–Ω—ñ –º–æ–≤–∏)
   
4. choose_target_language() ‚Üí TranslationStates.waiting_for_file
   ‚Üì document upload
   
5. handle_file() ‚Üí TranslationStates.waiting_for_payment_confirmation
   ‚Üì process_payment
   
6. process_payment() ‚Üí Stripe —Å–µ—Å—ñ—è ‚Üí webhook confirmation
   ‚Üì start_translation
   
7. TranslationStates.translating ‚Üí TranslationStates.completed
```

## üî• –ö–õ–Æ–ß–û–í–Ü –û–°–û–ë–õ–ò–í–û–°–¢–Ü

### ‚úÖ –ù–∞–¥—ñ–π–Ω—ñ—Å—Ç—å
- –ö–æ–∂–µ–Ω handler –º–∞—î —Å–≤—ñ–π —Ñ—ñ–ª—å—Ç—Ä —ñ —Å—Ç–∞–Ω
- –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π fallback –¥–ª—è –≤—Å—ñ—Ö –Ω–µ–≤—ñ–¥–æ–º–∏—Ö callback'—ñ–≤
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–æ–∫
- –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∫–æ–∂–Ω–æ—ó –¥—ñ—ó

### ‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å
- Middleware –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –ö–µ—à—É–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—ñ–≤
- –û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—ñ –ø–µ—Ä–µ—Ö–æ–¥–∏ –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏

### üõ°Ô∏è –ë–µ–∑–ø–µ–∫–∞
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –≤—Å—ñ—Ö –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞–Ω—ñ–≤ –ø–µ—Ä–µ–¥ –æ–±—Ä–æ–±–∫–æ—é
- Graceful error handling
- –°–∞–Ω—ñ—Ç–∏–∑–∞—Ü—ñ—è –≤—Ö–æ–¥—ñ–≤

## üìã –§–ê–ô–õ–ò –Ø–ö–Ü –ó–ú–Ü–ù–ï–ù–û

### ‚úèÔ∏è –ú–æ–¥–∏—Ñ—ñ–∫–æ–≤–∞–Ω—ñ:
- `handlers/start.py` - –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–æ —Ñ—ñ–ª—å—Ç—Ä–∏
- `handlers/language.py` - –¥–æ–¥–∞–Ω–æ —Å—Ç–∞–Ω–∏
- `handlers/payment.py` - –¥–æ–¥–∞–Ω–æ debug
- `handlers/__init__.py` - –¥–æ–¥–∞–Ω–æ universal handler
- `bot.py` - –¥–æ–¥–∞–Ω–æ middleware

### üÜï –ù–æ–≤—ñ —Ñ–∞–π–ª–∏:
- `utils/debug_logger.py` - —Å–∏—Å—Ç–µ–º–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- `utils/flow_manager.py` - –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ç–∞–Ω—ñ–≤
- `handlers/universal.py` - —É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π handler
- `test_flow.py` - —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —Å–∏—Å—Ç–µ–º–∏

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

```bash
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
python3 bot.py

# –õ–æ–≥–∏ –¥–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è  
tail -f logs/debug_flow.log

# –û—Å–Ω–æ–≤–Ω—ñ –ª–æ–≥–∏
tail -f logs/bot.log
```

## üìä –ú–û–ù–Ü–¢–û–†–ò–ù–ì

### –õ–æ–≥–∏ —è–∫—ñ —Å—Ç–≤–æ—Ä—é—é—Ç—å—Å—è:
```
logs/
‚îú‚îÄ‚îÄ bot.log - –æ—Å–Ω–æ–≤–Ω—ñ –ª–æ–≥–∏ –±–æ—Ç–∞
‚îú‚îÄ‚îÄ debug_flow.log - –¥–µ—Ç–∞–ª—å–Ω–∏–π user flow  
‚îî‚îÄ‚îÄ payment.log - –ø–ª–∞—Ç—ñ–∂–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
```

### –ö–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è:
- –í—Å—ñ callback'–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤
- –ü–µ—Ä–µ—Ö–æ–¥–∏ –º—ñ–∂ —Å—Ç–∞–Ω–∞–º–∏  
- –ü–æ–º–∏–ª–∫–∏ —Ç–∞ —ó—Ö –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è
- –ü–ª–∞—Ç—ñ–∂–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó
- –í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö

## üö® –ö–û–ù–¢–†–û–õ–¨–ù–ò–ô –°–ü–ò–°–û–ö

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–≤–∏—Å–∞–Ω–Ω—è –≤–∏—Ä—ñ—à–µ–Ω–∞:
- [x] Handler'–∏ –º–∞—é—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
- [x] –°—Ç–∞–Ω–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ
- [x] –ù–µ–º–∞—î –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—ñ–≤ –º—ñ–∂ callback'–∞–º–∏
- [x] –£–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω–∏–π fallback –ø—Ä–∞—Ü—é—î

### ‚úÖ –°–∏—Å—Ç–µ–º–∞ —Å—É–ø–µ—Ä-–Ω–∞–¥—ñ–π–Ω–∞:
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–æ–∫
- [x] –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –¥—ñ–π
- [x] –í–∞–ª—ñ–¥–∞—Ü—ñ—è –Ω–∞ –∫–æ–∂–Ω–æ–º—É –∫—Ä–æ—Ü—ñ
- [x] Fallback –¥–ª—è –Ω–µ–≤—ñ–¥–æ–º–∏—Ö –∫–æ–º–∞–Ω–¥

### ‚úÖ User Experience –ø–æ–∫—Ä–∞—â–µ–Ω–æ:
- [x] –ó—Ä–æ–∑—É–º—ñ–ª—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏
- [x] –ü–æ–∫–∞–∑ –ø—Ä–æ–≥—Ä–µ—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
- [x] –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –∑ –±—É–¥—å-—è–∫–æ–≥–æ –∫—Ä–æ–∫—É
- [x] –®–≤–∏–¥–∫–µ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ—Å–ª—è –∑–±–æ—ó–≤

## üéâ –†–ï–ó–£–õ–¨–¢–ê–¢

**–ü–†–û–ë–õ–ï–ú–ê –ü–û–í–ù–Ü–°–¢–Æ –í–ò–†–Ü–®–ï–ù–ê!** 

–¢–µ–ø–µ—Ä –±–æ—Ç:
- ‚úÖ –ù–ï –∑–∞–≤–∏—Å–∞—î –ø—Ä–∏ –≤–∏–±–æ—Ä—ñ –º–æ–¥–µ–ª—ñ
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–æ–±–ª—è—î –≤—Å—ñ callback'–∏
- ‚úÖ –õ–æ–≥—É—î –≤—Å—ñ –¥—ñ—ó –¥–ª—è –≤—ñ–¥–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤—ñ–¥–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—ñ—Å–ª—è –ø–æ–º–∏–ª–æ–∫
- ‚úÖ –ú–∞—î –¥–µ—Ç–∞–ª—å–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ user flow

---
**üöÄ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê –î–û –ü–†–û–î–ê–ö–®–ï–ù–£!**